<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catching Butterflies</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Arial', sans-serif;
        overflow: hidden;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    #menuPage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }

    .menu-content {
        text-align: center;
        color: white;
    }

    .menu-content h1 {
        font-size: 64px;
        margin-bottom: 50px;
        text-shadow: 4px 4px 8px rgba(0,0,0,0.5);
    }

    .menu-button {
        width: 300px;
        padding: 20px;
        margin: 15px;
        font-size: 24px;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        background: white;
        color: #667eea;
        font-weight: bold;
        transition: all 0.3s;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .menu-button:hover, .menu-button.selected {
        transform: scale(1.1);
        box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        background: #ffd700;
        color: #000;
    }

    #gameCanvas {
        display: none;
        width: 100%;
        height: 100vh;
    }

    #ui {
        position: absolute;
        top: 20px;
        left: 20px;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        font-size: 18px;
        pointer-events: none;
        z-index: 100;
        background: rgba(0,0,0,0.6);
        padding: 15px;
        border-radius: 10px;
    }

    #objective {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        font-size: 20px;
        pointer-events: none;
        z-index: 100;
        background: rgba(255, 215, 0, 0.3);
        border: 3px solid #ffd700;
        padding: 20px;
        border-radius: 15px;
        min-width: 300px;
    }

    #objective h3 {
        color: #ffd700;
        font-size: 24px;
        margin-bottom: 10px;
        text-align: center;
    }

    #undergroundStats {
        display: none;
        margin-top: 10px;
    }

    #notification {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 20px 40px;
        border-radius: 10px;
        font-size: 24px;
        display: none;
        z-index: 200;
    }

    #levelUpNotification {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #fff;
        padding: 50px 80px;
        border-radius: 20px;
        font-size: 48px;
        font-weight: bold;
        display: none;
        z-index: 300;
        text-align: center;
        box-shadow: 0 0 50px rgba(138, 43, 226, 0.8);
        border: 5px solid #8b5cf6;
    }

    #levelUpNotification.show {
        display: block;
        animation: levelUpPulse 0.5s ease-out forwards;
    }

    @keyframes levelUpPulse {
        0% { transform: translate(-50%, -50%) scale(0); }
        50% { transform: translate(-50%, -50%) scale(1.2); }
        100% { transform: translate(-50%, -50%) scale(1); }
    }

    #completionScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
        color: white;
        z-index: 1000;
    }

    #completionScreen.show {
        display: flex;
        animation: fadeIn 1s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    #completionScreen h1 {
        font-size: 72px;
        margin-bottom: 30px;
        animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-20px); }
    }

    #completionScreen p {
        font-size: 28px;
        margin: 15px 0;
    }

    #completionScreen button {
        margin-top: 50px;
        padding: 20px 50px;
        font-size: 24px;
        background: white;
        color: #667eea;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    #completionScreen button:hover,
    #completionScreen button.selected {
        transform: scale(1.1);
        background: #ffd700;
        color: #000;
        box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }

    #store {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.98);
        color: #333;
        padding: 40px;
        border-radius: 20px;
        display: none;
        min-width: 550px;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 300;
        pointer-events: auto;
        box-shadow: 0 10px 50px rgba(0,0,0,0.5);
    }

    #store::-webkit-scrollbar {
        width: 12px;
    }

    #store::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    #store::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
    }

    #store::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
    }

    #store h2 {
        margin-bottom: 20px;
        color: #2c3e50;
        font-size: 32px;
        text-align: center;
    }

    #store h3 {
        margin-top: 30px;
        margin-bottom: 15px;
        color: #34495e;
        font-size: 24px;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
    }

    #storeStatus {
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        color: #27ae60;
        margin-bottom: 20px;
        padding: 10px;
        background: rgba(46, 204, 113, 0.1);
        border-radius: 10px;
    }

    #store button {
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        font-size: 18px;
        border: 3px solid transparent;
        border-radius: 10px;
        cursor: pointer;
        background: #3498db;
        color: white;
        font-weight: bold;
        transition: all 0.3s ease;
        text-align: left;
        position: relative;
    }

    #store button:hover {
        background: #2980b9;
        transform: scale(1.02);
    }

    #store button.selected {
        background: #2980b9;
        transform: scale(1.05);
        border: 3px solid #ffd700;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }
        50% {
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.9);
        }
    }

    #store button.selected::before {
        content: '‚ñ∂';
        position: absolute;
        left: -25px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 20px;
        color: #ffd700;
        animation: bounce-arrow 0.6s ease-in-out infinite;
    }

    @keyframes bounce-arrow {
        0%, 100% {
            left: -25px;
        }
        50% {
            left: -20px;
        }
    }

    #store .close {
        background: #e74c3c;
        text-align: center;
        margin-top: 20px;
    }

    #store .close:hover {
        background: #c0392b;
    }

    #store .close.selected {
        background: #c0392b;
        border: 3px solid #ffd700;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
    }

    .purchased {
        background: #27ae60 !important;
    }

    .purchased:hover {
        background: #229954 !important;
    }

    .purchased.selected {
        background: #229954 !important;
        border: 3px solid #ffd700;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
    }

    #characterButtons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .character-button {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
    }

    .character-preview {
        font-size: 30px;
    }

    .money-negative {
        color: #e74c3c;
    }

    #controllerStatus {
        position: absolute;
        bottom: 20px;
        left: 20px;
        color: white;
        background: rgba(0,0,0,0.6);
        padding: 10px 15px;
        border-radius: 10px;
        font-size: 14px;
        z-index: 100;
    }

    .hidden {
        display: none !important;
    }
    </style>
</head>
<body>
    <div id="menuPage">
        <div class="menu-content">
            <h1>ü¶ã Catching Butterflies</h1>
            <button class="menu-button selected" id="startButton">Start Game</button>
            <p style="margin-top: 30px; font-size: 16px; color: rgba(255,255,255,0.8);">
                üéÆ Nintendo Switch Controller:<br>
                Press A to Start<br>
                Left Stick = Move | Right Stick = Camera<br>
                + Button = Store | B = Back | A = Catch
            </p>
        </div>
    </div>

    <div id="gameCanvas"></div>
    
    <div id="ui">
        <div id="level">Level: 1</div>
        <div id="money">Money: $0</div>
        <div id="caught">Butterflies: 0/101</div>
        <div id="spiders" style="display:none;">Spiders: 0/50</div>
        <div id="tool">Tool: Hands</div>
        <div id="character">Character: Default</div>
        
        <div id="undergroundStats">
            <div id="ants">üêú Ants: 0/20</div>
            <div id="worms">ü™± Worms: 0/20</div>
            <div id="snails">üêå Snails: 0/20</div>
            <div id="bugs">üêõ Bugs: 0/20</div>
            <div id="crickets">ü¶ó Crickets: 0/20</div>
        </div>
        
        <div style="margin-top: 10px; font-size: 14px;">üéÆ Left Stick = Move | A = Catch | + = Store</div>
    </div>

    <div id="controllerStatus">üéÆ Waiting for controller...</div>

    <div id="objective">
        <h3>üìã Objective</h3>
        <p id="objectiveText">Catch 101 butterflies!</p>
    </div>

    <div id="notification"></div>

    <div id="levelUpNotification">
        <div class="level-text">LEVEL UP!</div>
        <div class="level-subtitle">Get ready!</div>
    </div>

    <div id="store">
        <h2>ü¶ã Shop</h2>
        <p id="storeStatus">Money: $0</p>
        
        <div id="netsContainer">
            <h3>Nets</h3>
            <div id="netButtons"></div>
        </div>

        <h3>Character Upgrades ($250)</h3>
        <div id="characterButtons"></div>

        <button class="close" id="storeClose">Close Store</button>
    </div>

    <div id="completionScreen">
        <h1>üéâ Congratulations! üéâ</h1>
        <p>Thank you for playing my first game demo.</p>
        <p>I hope you enjoyed playing this game.</p>
        <p>Thank you!</p>
        <button id="playAgainButton" class="selected">Play Again</button>
        <p style="margin-top: 20px; font-size: 18px; color: rgba(255,255,255,0.8);">
            üéÆ Press A to Play Again
        </p>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';

        console.log("Game script loading...");

        const butterflyTypes = [
            { name: "Monarch", emoji: "ü¶ã", color: 0xff8c00, speed: 2.5, value: 6, scale: 3.0 },
            { name: "Blue Morpho", emoji: "ü¶ã", color: 0x0080ff, speed: 3.5, value: 15, scale: 3.5 },
            { name: "Swallowtail", emoji: "ü¶ã", color: 0xffff00, speed: 2.8, value: 8, scale: 2.8 },
        ];

        const undergroundCreatureTypes = [
            { name: "Ant", emoji: "üêú", type: "ants", speed: 1.5, value: 2, scale: 2.0, yPos: 0.2 },
            { name: "Worm", emoji: "ü™±", type: "worms", speed: 0.8, value: 3, scale: 2.5, yPos: 0.3 },
            { name: "Snail", emoji: "üêå", type: "snails", speed: 0.5, value: 4, scale: 2.2, yPos: 0.2 },
            { name: "Bug", emoji: "üêõ", type: "bugs", speed: 1.2, value: 3, scale: 2.3, yPos: 0.25 },
            { name: "Cricket", emoji: "ü¶ó", type: "crickets", speed: 2.0, value: 5, scale: 2.4, yPos: 0.2 }
        ];

        const characterTypes = [
            { name: "Default", emoji: null, purchased: true },
            { name: "Astronaut", emoji: "üßë‚ÄçüöÄ", purchased: false },
            { name: "Police", emoji: "üëÆ", purchased: false },
            { name: "Elf", emoji: "üßù", purchased: false },
            { name: "Pilot", emoji: "üßë‚Äç‚úàÔ∏è", purchased: false },
            { name: "Firefighter", emoji: "üßë‚Äçüöí", purchased: false }
        ];

        const netTiers = [
            { name: "Basic Net", price: 12, durability: 10, range: 8 },
            { name: "Advanced Net", price: 24, durability: 5, range: 10 },
            { name: "Rare Net", price: 36, durability: Infinity, range: 12 }
        ];

        let gameState = {
            level: 1,
            money: 0,
            butterfliesCaught: 0,
            spidersCaught: 0,
            undergroundCaught: { ants: 0, worms: 0, snails: 0, bugs: 0, crickets: 0 },
            currentNet: null,
            catchRange: 4,
            currentCharacterIndex: 0,
            isPaused: false,
            isPlaying: false,
            storeUnlocked: false
        };

        let menuState = {
            currentMenu: 'main',
            selectedIndex: 0,
            menuButtons: []
        };

        let gamepad = null;
        let previousButtonStates = {};
        let previousDPadState = { up: false, down: false, left: false, right: false };
        let lastScrollTime = 0;
        
        let scene, camera, renderer, player, netGroup;
        let butterflies = [], spiders = [], undergroundCreatures = [];
        let clock, ambientLight, directionalLight, ground;
        let cameraAngle = 0;

        window.addEventListener("gamepadconnected", (e) => {
            console.log("Controller connected:", e.gamepad.id);
            gamepad = e.gamepad;
            document.getElementById('controllerStatus').textContent = 'üéÆ Nintendo Switch Controller Connected';
            document.getElementById('controllerStatus').style.background = 'rgba(0,128,0,0.6)';
        });

        window.addEventListener("gamepaddisconnected", (e) => {
            console.log("Controller disconnected");
            gamepad = null;
            document.getElementById('controllerStatus').textContent = 'üéÆ Controller Disconnected';
            document.getElementById('controllerStatus').style.background = 'rgba(128,0,0,0.6)';
        });

        function getGamepad() {
            const gamepads = navigator.getGamepads();
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) return gamepads[i];
            }
            return null;
        }

        function isButtonPressed(buttonIndex) {
            const gp = getGamepad();
            if (!gp) return false;
            
            const pressed = gp.buttons[buttonIndex] && gp.buttons[buttonIndex].pressed;
            const wasPressed = previousButtonStates[buttonIndex];
            previousButtonStates[buttonIndex] = pressed;
            
            return pressed && !wasPressed;
        }

        function updateMenuButtons() {
            menuState.menuButtons.forEach(btn => btn.classList.remove('selected'));

            if (menuState.currentMenu === 'main') {
                menuState.menuButtons = [document.getElementById('startButton')];
            } else if (menuState.currentMenu === 'completion') {
                menuState.menuButtons = [document.getElementById('playAgainButton')];
            } else if (menuState.currentMenu === 'store') {
                const buttons = [];
                if (gameState.level !== 3) {
                    document.querySelectorAll('#netButtons button').forEach(btn => buttons.push(btn));
                }
                document.querySelectorAll('#characterButtons button').forEach(btn => buttons.push(btn));
                buttons.push(document.getElementById('storeClose'));
                menuState.menuButtons = buttons;
            }

            menuState.selectedIndex = Math.max(0, Math.min(menuState.selectedIndex, menuState.menuButtons.length - 1));

            if (menuState.menuButtons[menuState.selectedIndex]) {
                menuState.menuButtons[menuState.selectedIndex].classList.add('selected');
            }
        }

        function getDPadInput() {
            const gp = getGamepad();
            if (!gp) return { up: false, down: false };

            let upPressed = gp.buttons[12] && gp.buttons[12].pressed;
            let downPressed = gp.buttons[13] && gp.buttons[13].pressed;
            
            const upJustPressed = upPressed && !previousDPadState.up;
            const downJustPressed = downPressed && !previousDPadState.down;
            
            previousDPadState.up = upPressed;
            previousDPadState.down = downPressed;

            return { 
                up: upJustPressed, 
                down: downJustPressed 
            };
        }

        function handleMenuNavigation() {
            if (menuState.currentMenu === 'main' || menuState.currentMenu === 'completion') {
                // A button (button 1) to select
                if (isButtonPressed(1) || isButtonPressed(0)) {
                    const selectedButton = menuState.menuButtons[menuState.selectedIndex];
                    if (selectedButton) {
                        console.log("Controller A button pressed - clicking button");
                        selectedButton.click();
                    }
                }
            } else if (menuState.currentMenu === 'store') {
                const dpad = getDPadInput();
                
                // D-Pad navigation
                if (dpad.up) {
                    menuState.selectedIndex--;
                    if (menuState.selectedIndex < 0) {
                        menuState.selectedIndex = menuState.menuButtons.length - 1;
                    }
                    updateMenuButtons();
                    scrollToSelected();
                }

                if (dpad.down) {
                    menuState.selectedIndex++;
                    if (menuState.selectedIndex >= menuState.menuButtons.length) {
                        menuState.selectedIndex = 0;
                    }
                    updateMenuButtons();
                    scrollToSelected();
                }

                // A button to select
                if (isButtonPressed(1)) {
                    const selectedButton = menuState.menuButtons[menuState.selectedIndex];
                    if (selectedButton) {
                        selectedButton.click();
                    }
                }

                // B button (button 0) to close store
                if (isButtonPressed(0)) {
                    toggleStore();
                }
            }
        }

        function scrollToSelected() {
            const now = Date.now();
            if (now - lastScrollTime < 100) return;
            lastScrollTime = now;
            
            if (menuState.menuButtons[menuState.selectedIndex]) {
                const selectedButton = menuState.menuButtons[menuState.selectedIndex];
                
                selectedButton.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'nearest'
                });
                
                selectedButton.style.transition = 'all 0.3s ease';
            }
        }

        function setupButtons() {
            console.log("Setting up buttons...");
            
            const startBtn = document.getElementById('startButton');
            if (startBtn) {
                startBtn.onclick = function() {
                    console.log("Start button clicked!");
                    startGame();
                };
                console.log("Start button handler attached");
            } else {
                console.error("Start button not found!");
            }

            const storeCloseBtn = document.getElementById('storeClose');
            if (storeCloseBtn) {
                storeCloseBtn.onclick = function() {
                    console.log("Store close clicked!");
                    toggleStore();
                };
            }

            const playAgainBtn = document.getElementById('playAgainButton');
            if (playAgainBtn) {
                playAgainBtn.onclick = function() {
                    console.log("Play again clicked!");
                    returnToMainMenu();
                };
            }
        }

        function startGame() {
            console.log("Starting game...");
            document.getElementById('menuPage').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            menuState.currentMenu = 'game';
            gameState.isPlaying = true;
            initGame();
        }

        function returnToMainMenu() {
            console.log("Returning to main menu...");
            
            document.getElementById('completionScreen').classList.remove('show');
            document.getElementById('completionScreen').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('menuPage').style.display = 'flex';
            
            gameState = {
                level: 1,
                money: 0,
                butterfliesCaught: 0,
                spidersCaught: 0,
                undergroundCaught: { ants: 0, worms: 0, snails: 0, bugs: 0, crickets: 0 },
                currentNet: null,
                catchRange: 4,
                currentCharacterIndex: 0,
                isPaused: false,
                isPlaying: false,
                storeUnlocked: false
            };
            
            characterTypes.forEach((char, i) => {
                if (i === 0) char.purchased = true;
                else char.purchased = false;
            });
            
            if (scene) {
                butterflies.forEach(b => b.remove());
                butterflies = [];
                spiders.forEach(s => s.remove());
                spiders = [];
                undergroundCreatures.forEach(c => c.remove());
                undergroundCreatures = [];
                
                if (renderer && renderer.domElement && renderer.domElement.parentElement) {
                    renderer.domElement.parentElement.removeChild(renderer.domElement);
                }
                
                scene = null;
                renderer = null;
            }
            
            document.getElementById('caught').style.display = 'block';
            document.getElementById('caught').textContent = 'Butterflies: 0/101';
            document.getElementById('spiders').style.display = 'none';
            document.getElementById('spiders').textContent = 'Spiders: 0/50';
            document.getElementById('undergroundStats').style.display = 'none';
            document.getElementById('ants').textContent = 'üêú Ants: 0/20';
            document.getElementById('worms').textContent = 'ü™± Worms: 0/20';
            document.getElementById('snails').textContent = 'üêå Snails: 0/20';
            document.getElementById('bugs').textContent = 'üêõ Bugs: 0/20';
            document.getElementById('crickets').textContent = 'ü¶ó Crickets: 0/20';
            
            menuState.currentMenu = 'main';
            menuState.selectedIndex = 0;
            updateMenuButtons();
        }

        function toggleStore() {
            const store = document.getElementById('store');
            const netsContainer = document.getElementById('netsContainer');
            
            if (gameState.level === 3) {
                netsContainer.classList.add('hidden');
            } else {
                netsContainer.classList.remove('hidden');
            }
            
            if (store.style.display === 'block') {
                store.style.display = 'none';
                menuState.currentMenu = 'game';
            } else {
                store.style.display = 'block';
                menuState.currentMenu = 'store';
                menuState.selectedIndex = 0;
                updateMenuButtons();
            }
        }

        function initGame() {
            console.log("Initializing game...");
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('gameCanvas').appendChild(renderer.domElement);

            ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const groundGeometry = new THREE.PlaneGeometry(150, 150);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            player = new THREE.Group();
            const playerGeometry = new THREE.CapsuleGeometry(0.5, 1.5, 4, 8);
            const playerMaterial = new THREE.MeshLambertMaterial({ color: 0x0066ff });
            const playerMesh = new THREE.Mesh(playerGeometry, playerMaterial);
            playerMesh.castShadow = true;
            player.add(playerMesh);
            player.position.set(0, 1.5, 0);
            scene.add(player);

            createNet();
            createPlayground();
            camera.position.set(0, 8, 12);
            
            spawnButterflies(15);
            setupStore();

            clock = new THREE.Clock();
            updateUI();
            updateObjective();
            console.log("Game initialized successfully!");
        }

        function createNet() {
            netGroup = new THREE.Group();
            const hoopGeometry = new THREE.TorusGeometry(0.8, 0.08, 16, 32);
            const hoopMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
            const hoop = new THREE.Mesh(hoopGeometry, hoopMaterial);
            hoop.rotation.x = Math.PI / 2;
            netGroup.add(hoop);
            
            const netShape = new THREE.ConeGeometry(0.8, 2.5, 8, 4, true);
            const netMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff, wireframe: true });
            const netMesh = new THREE.Mesh(netShape, netMaterial);
            netMesh.position.y = -1.25;
            netGroup.add(netMesh);
            
            const handleGeometry = new THREE.CylinderGeometry(0.05, 0.05, 2.5, 8);
            const handleMaterial = new THREE.MeshLambertMaterial({ color: 0x8b4513 });
            const handle = new THREE.Mesh(handleGeometry, handleMaterial);
            handle.position.y = -2.5;
            netGroup.add(handle);
            
            netGroup.position.set(0.7, 0.5, -2);
            netGroup.rotation.x = Math.PI / 6;
            netGroup.visible = false;
            player.add(netGroup);
        }

        function createPlayground() {
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const x = Math.cos(angle) * 45;
                const z = Math.sin(angle) * 45;
                scene.add(createTree(x, z));
            }
        }

        function createTree(x, z) {
            const treeGroup = new THREE.Group();
            
            const trunkGeometry = new THREE.CylinderGeometry(0.3, 0.4, 5, 8);
            const trunkMaterial = new THREE.MeshLambertMaterial({ color: 0x4a2511 });
            const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
            trunk.position.y = 2.5;
            trunk.castShadow = true;
            treeGroup.add(trunk);
            
            const foliageGeometry = new THREE.ConeGeometry(2, 4, 8);
            const foliageMaterial = new THREE.MeshLambertMaterial({ color: 0x228b22 });
            const foliage1 = new THREE.Mesh(foliageGeometry, foliageMaterial);
            foliage1.position.y = 6;
            foliage1.castShadow = true;
            treeGroup.add(foliage1);
            
            treeGroup.position.set(x, 0, z);
            return treeGroup;
        }

        function createFlower(x, z) {
            const flowerGroup = new THREE.Group();
            
            const stemGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.8, 8);
            const stemMaterial = new THREE.MeshLambertMaterial({ color: 0x228b22 });
            const stem = new THREE.Mesh(stemGeometry, stemMaterial);
            stem.position.y = 0.4;
            flowerGroup.add(stem);
            
            const petalColors = [0xff1493, 0xffff00, 0xff69b4, 0xff4500, 0x9370db];
            const petalColor = petalColors[Math.floor(Math.random() * petalColors.length)];
            const petalGeometry = new THREE.SphereGeometry(0.15, 8, 8);
            const petalMaterial = new THREE.MeshLambertMaterial({ color: petalColor });
            
            for (let i = 0; i < 5; i++) {
                const petal = new THREE.Mesh(petalGeometry, petalMaterial);
                const angle = (i / 5) * Math.PI * 2;
                petal.position.set(Math.cos(angle) * 0.2, 0.8, Math.sin(angle) * 0.2);
                flowerGroup.add(petal);
            }
            
            flowerGroup.position.set(x, 0, z);
            return flowerGroup;
        }

        function setupStore() {
            const netContainer = document.getElementById('netButtons');
            netContainer.innerHTML = '';
            netTiers.forEach((net, i) => {
                const btn = document.createElement('button');
                btn.innerHTML = `<strong>${net.name} - $${net.price}</strong><br>Range: ${net.range}`;
                btn.onclick = () => {
                    if (gameState.level === 3) {
                        showNotification("Nets not needed underground!", true);
                        return;
                    }
                    if (gameState.money >= net.price) {
                        gameState.money -= net.price;
                        gameState.currentNet = i;
                        netGroup.visible = true;
                        showNotification(`${net.name} bought!`);
                        updateUI();
                    } else {
                        showNotification(`Need $${net.price}`, true);
                    }
                };
                netContainer.appendChild(btn);
            });

            updateCharacterButtons();
        }

        function updateCharacterButtons() {
            const charContainer = document.getElementById('characterButtons');
            charContainer.innerHTML = '';
            
            characterTypes.forEach((char, i) => {
                const btn = document.createElement('button');
                btn.className = 'character-button';
                btn.innerHTML = `<span class="character-preview">${char.emoji || 'üë§'}</span><span>${char.name} - ${char.purchased ? 'OWNED' : '$250'}</span>`;
                if (char.purchased) btn.classList.add('purchased');
                btn.onclick = () => {
                    if (char.purchased) {
                        gameState.currentCharacterIndex = i;
                        updatePlayerAppearance();
                        showNotification(`Character: ${char.name}`);
                        updateUI();
                    } else if (gameState.money >= 250) {
                        gameState.money -= 250;
                        characterTypes[i].purchased = true;
                        gameState.currentCharacterIndex = i;
                        updatePlayerAppearance();
                        showNotification(`${char.name} purchased!`);
                        updateUI();
                        updateCharacterButtons();
                    } else {
                        showNotification('Need $250', true);
                    }
                };
                charContainer.appendChild(btn);
            });
        }

        function updatePlayerAppearance() {
            const childrenToRemove = [];
            player.children.forEach(child => {
                if (child !== netGroup) {
                    childrenToRemove.push(child);
                }
            });
            childrenToRemove.forEach(child => {
                player.remove(child);
                if (child.geometry) child.geometry.dispose();
                if (child.material) {
                    if (child.material.map) child.material.map.dispose();
                    child.material.dispose();
                }
            });

            const currentChar = characterTypes[gameState.currentCharacterIndex];
            
            if (currentChar.emoji) {
                const texture = createEmojiTexture(currentChar.emoji);
                const spriteMaterial = new THREE.SpriteMaterial({ 
                    map: texture,
                    transparent: true
                });
                const playerSprite = new THREE.Sprite(spriteMaterial);
                playerSprite.scale.set(2.5, 2.5, 1);
                playerSprite.position.y = 0;
                player.add(playerSprite);
            } else {
                const playerGeometry = new THREE.CapsuleGeometry(0.5, 1.5, 4, 8);
                const playerMaterial = new THREE.MeshLambertMaterial({ color: 0x0066ff });
                const playerMesh = new THREE.Mesh(playerGeometry, playerMaterial);
                playerMesh.castShadow = true;
                player.add(playerMesh);
            }
        }

        function createEmojiTexture(emoji) {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.font = '200px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(emoji, 128, 128);
            return new THREE.CanvasTexture(canvas);
        }

        class Butterfly {
            constructor() {
                this.type = butterflyTypes[Math.floor(Math.random() * butterflyTypes.length)];
                this.sprite = new THREE.Sprite(new THREE.SpriteMaterial({ 
                    map: createEmojiTexture(this.type.emoji),
                    transparent: true,
                    color: this.type.color
                }));
                this.sprite.scale.set(this.type.scale, this.type.scale, 1);
                this.sprite.position.set(Math.random() * 40 - 20, Math.random() * 5 + 3, Math.random() * 40 - 20);
                this.velocity = new THREE.Vector3();
                this.targetPosition = this.sprite.position.clone();
                this.timer = 0;
                scene.add(this.sprite);
            }

            get mesh() { return this.sprite; }

            update(dt) {
                this.timer += dt;
                if (this.timer >= 3) {
                    this.targetPosition.set(Math.random() * 40 - 20, Math.random() * 5 + 3, Math.random() * 40 - 20);
                    this.timer = 0;
                }
                const dir = new THREE.Vector3().subVectors(this.targetPosition, this.sprite.position).normalize();
                this.velocity.lerp(dir.multiplyScalar(this.type.speed), 0.1);
                this.sprite.position.add(this.velocity.clone().multiplyScalar(dt));
            }

            remove() {
                scene.remove(this.sprite);
                if (this.sprite.material.map) this.sprite.material.map.dispose();
                this.sprite.material.dispose();
            }
        }

        class Spider {
            constructor() {
                this.sprite = new THREE.Sprite(new THREE.SpriteMaterial({ 
                    map: createEmojiTexture('üï∑Ô∏è'),
                    transparent: true
                }));
                this.sprite.scale.set(2, 2, 1);
                this.sprite.position.set(Math.random() * 60 - 30, 0.3, Math.random() * 60 - 30);
                this.velocity = new THREE.Vector3();
                this.targetPosition = this.sprite.position.clone();
                this.timer = 0;
                scene.add(this.sprite);
            }

            get mesh() { return this.sprite; }
            
            update(dt) {
                this.timer += dt;
                if (this.timer >= 4) {
                    this.targetPosition.set(Math.random() * 60 - 30, 0.3, Math.random() * 60 - 30);
                    this.timer = 0;
                }
                const dir = new THREE.Vector3().subVectors(this.targetPosition, this.sprite.position).normalize();
                this.velocity.lerp(dir.multiplyScalar(0.6), 0.05);
                this.sprite.position.add(this.velocity.clone().multiplyScalar(dt));
                this.sprite.position.y = 0.3;
            }

            remove() {
                scene.remove(this.sprite);
                if (this.sprite.material.map) this.sprite.material.map.dispose();
                this.sprite.material.dispose();
            }
        }

        class UndergroundCreature {
            constructor(type) {
                this.type = type;
                this.sprite = new THREE.Sprite(new THREE.SpriteMaterial({ 
                    map: createEmojiTexture(type.emoji),
                    transparent: true
                }));
                this.sprite.scale.set(type.scale, type.scale, 1);
                this.sprite.position.set(Math.random() * 60 - 30, type.yPos, Math.random() * 60 - 30);
                this.velocity = new THREE.Vector3();
                this.targetPosition = this.sprite.position.clone();
                this.timer = 0;
                this.changeInterval = Math.random() * 3 + 2;
                scene.add(this.sprite);
            }

            get mesh() { return this.sprite; }
            
            update(dt) {
                this.timer += dt;
                if (this.timer >= this.changeInterval) {
                    this.targetPosition.set(
                        Math.random() * 60 - 30, 
                        this.type.yPos, 
                        Math.random() * 60 - 30
                    );
                    this.timer = 0;
                    this.changeInterval = Math.random() * 3 + 2;
                }
                
                const dir = new THREE.Vector3().subVectors(this.targetPosition, this.sprite.position).normalize();
                this.velocity.lerp(dir.multiplyScalar(this.type.speed), 0.08);
                this.sprite.position.add(this.velocity.clone().multiplyScalar(dt));
                this.sprite.position.y = this.type.yPos;
            }

            remove() {
                scene.remove(this.sprite);
                if (this.sprite.material.map) this.sprite.material.map.dispose();
                this.sprite.material.dispose();
            }
        }

        function spawnButterflies(count) {
            for (let i = 0; i < count; i++) {
                butterflies.push(new Butterfly());
            }
        }

        function spawnSpiders(count) {
            for (let i = 0; i < count; i++) {
                spiders.push(new Spider());
            }
        }

        function spawnUnderground() {
            undergroundCreatureTypes.forEach(type => {
                for (let i = 0; i < 8; i++) {
                    undergroundCreatures.push(new UndergroundCreature(type));
                }
            });
        }

        function tryCatch() {
            const range = gameState.currentNet !== null ? netTiers[gameState.currentNet].range : gameState.catchRange;
            let closest = null;
            let closestDist = range;
            let type = null;

            const creatures = gameState.level === 1 ? butterflies : 
                             gameState.level === 2 ? spiders : undergroundCreatures;

            creatures.forEach(c => {
                const dist = player.position.distanceTo(c.mesh.position);
                if (dist < closestDist) {
                    closestDist = dist;
                    closest = c;
                    type = gameState.level;
                }
            });

            if (closest) {
                if (type === 1) catchButterfly(closest);
                else if (type === 2) catchSpider(closest);
                else catchUnderground(closest);
            } else {
                gameState.money = Math.max(0, gameState.money - 1);
                showNotification("Missed! -$1", true);
                updateUI();
            }
        }

        function catchButterfly(b) {
            gameState.money += b.type.value;
            gameState.butterfliesCaught++;
            
            b.remove();
            butterflies = butterflies.filter(x => x !== b);
            setTimeout(() => butterflies.push(new Butterfly()), 1000);
            
            if (gameState.butterfliesCaught === 101) {
                setTimeout(() => levelUp(2), 1000);
            }
            if (!gameState.storeUnlocked && gameState.butterfliesCaught >= 2) {
                gameState.storeUnlocked = true;
                setTimeout(() => showNotification("Store Unlocked! Press +"), 2500);
            }
            
            updateUI();
        }

        function catchSpider(s) {
            gameState.money += 1;
            gameState.spidersCaught++;
            
            s.remove();
            spiders = spiders.filter(x => x !== s);
            setTimeout(() => spiders.push(new Spider()), 2000);
            
            if (gameState.spidersCaught === 50) {
                setTimeout(() => levelUp(3), 1000);
            }
            
            updateUI();
        }

        function catchUnderground(c) {
            gameState.money += c.type.value;
            gameState.undergroundCaught[c.type.type]++;
            
            c.remove();
            undergroundCreatures = undergroundCreatures.filter(x => x !== c);
            setTimeout(() => undergroundCreatures.push(new UndergroundCreature(c.type)), 1500);
            
            const done = Object.values(gameState.undergroundCaught).every(x => x >= 20);
            if (done) {
                setTimeout(() => {
                    gameState.isPaused = true;
                    document.getElementById('completionScreen').classList.add('show');
                    menuState.currentMenu = 'completion';
                    menuState.selectedIndex = 0;
                    updateMenuButtons();
                }, 1000);
            }
            
            updateUI();
        }

        function levelUp(lvl) {
            gameState.level = lvl;
            gameState.isPaused = true;
            
            const notif = document.getElementById('levelUpNotification');
            notif.querySelector('.level-text').textContent = lvl === 2 ? 'üåô LEVEL 2! üåô' : 'ü™± LEVEL 3! ü™±';
            notif.querySelector('.level-subtitle').textContent = lvl === 2 ? 'Night Forest!' : 'Underground!';
            notif.classList.add('show');
            
            setTimeout(() => {
                notif.classList.remove('show');
                gameState.isPaused = false;
                
                if (lvl === 2) {
                    scene.background = new THREE.Color(0x0a0a1a);
                    ground.material.color = new THREE.Color(0x1a3a1a);
                    ambientLight.intensity = 0.15;
                    
                    for (let i = 0; i < 25; i++) {
                        const x = Math.random() * 80 - 40;
                        const z = Math.random() * 80 - 40;
                        scene.add(createFlower(x, z));
                    }
                    
                    spawnSpiders(15);
                } else {
                    butterflies.forEach(b => b.remove());
                    butterflies = [];
                    spiders.forEach(s => s.remove());
                    spiders = [];
                    
                    scene.background = new THREE.Color(0x2d1f15);
                    ground.material.color = new THREE.Color(0x6b4423);
                    ambientLight.color = new THREE.Color(0xaa8866);
                    ambientLight.intensity = 0.4;
                    
                    spawnUnderground();
                }
                
                updateObjective();
                updateUI();
            }, 3000);
        }

        function updateObjective() {
            const text = document.getElementById('objectiveText');
            if (gameState.level === 1) {
                text.innerHTML = 'ü¶ã Level 1: Kids Park<br>Catch 101 butterflies!';
            } else if (gameState.level === 2) {
                text.innerHTML = 'üåô Level 2: Night Forest<br>Catch 50 spiders!';
            } else {
                text.innerHTML = 'ü™± Level 3: Underground<br>Catch 20 of each creature!';
            }
        }

        function updateUI() {
            document.getElementById('level').textContent = `Level: ${gameState.level}`;
            document.getElementById('money').textContent = `Money: $${gameState.money}`;
            document.getElementById('storeStatus').textContent = `Money: $${gameState.money}`;
            document.getElementById('character').textContent = `Character: ${characterTypes[gameState.currentCharacterIndex].name}`;
            
            const toolText = gameState.currentNet !== null ? netTiers[gameState.currentNet].name : 'Hands';
            document.getElementById('tool').textContent = `Tool: ${toolText}`;

            if (gameState.level === 1) {
                document.getElementById('caught').style.display = 'block';
                document.getElementById('caught').textContent = `Butterflies: ${gameState.butterfliesCaught}/101`;
                document.getElementById('spiders').style.display = 'none';
                document.getElementById('undergroundStats').style.display = 'none';
            } 
            else if (gameState.level === 2) {
                document.getElementById('caught').style.display = 'none';
                document.getElementById('spiders').style.display = 'block';
                document.getElementById('spiders').textContent = `Spiders: ${gameState.spidersCaught}/50`;
                document.getElementById('undergroundStats').style.display = 'none';
            } 
            else {
                document.getElementById('caught').style.display = 'none';
                document.getElementById('spiders').style.display = 'none';
                document.getElementById('undergroundStats').style.display = 'block';
                document.getElementById('ants').textContent = `üêú Ants: ${gameState.undergroundCaught.ants}/20`;
                document.getElementById('worms').textContent = `ü™± Worms: ${gameState.undergroundCaught.worms}/20`;
                document.getElementById('snails').textContent = `üêå Snails: ${gameState.undergroundCaught.snails}/20`;
                document.getElementById('bugs').textContent = `üêõ Bugs: ${gameState.undergroundCaught.bugs}/20`;
                document.getElementById('crickets').textContent = `ü¶ó Crickets: ${gameState.undergroundCaught.crickets}/20`;
            }
        }

        function showNotification(msg, isNeg = false) {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = isNeg ? 'money-negative' : '';
            notif.style.display = 'block';
            setTimeout(() => notif.style.display = 'none', 2000);
        }

        function animate() {
            requestAnimationFrame(animate);

            if (menuState.currentMenu === 'main' || menuState.currentMenu === 'store' || menuState.currentMenu === 'completion') {
                handleMenuNavigation();
                if (renderer && scene && camera) renderer.render(scene, camera);
                return;
            }

            if (!gameState.isPlaying || gameState.isPaused) {
                if (renderer) renderer.render(scene, camera);
                return;
            }

            const dt = clock.getDelta();
            const gp = getGamepad();

            // Nintendo Switch Controller Movement
            if (gp) {
                // Left stick for movement
                const leftX = Math.abs(gp.axes[0]) > 0.15 ? gp.axes[0] : 0;
                const leftY = Math.abs(gp.axes[1]) > 0.15 ? gp.axes[1] : 0;

                if (leftX !== 0 || leftY !== 0) {
                    const move = new THREE.Vector3(leftX, 0, leftY);
                    move.normalize();
                    move.applyAxisAngle(new THREE.Vector3(0, 1, 0), cameraAngle);
                    player.position.add(move.multiplyScalar(8 * dt));
                    player.position.x = Math.max(-60, Math.min(60, player.position.x));
                    player.position.z = Math.max(-60, Math.min(60, player.position.z));
                }

                // Right stick for camera rotation
                const rightX = Math.abs(gp.axes[2]) > 0.15 ? gp.axes[2] : 0;
                if (rightX !== 0) {
                    cameraAngle += rightX * dt * 2;
                }

                // A button (button 1) to catch
                if (isButtonPressed(1)) {
                    tryCatch();
                }

                // + button (button 9) to open store
                if (isButtonPressed(9) && gameState.storeUnlocked) {
                    toggleStore();
                }
            }

            camera.position.set(
                player.position.x + Math.sin(cameraAngle) * 12,
                player.position.y + 8,
                player.position.z + Math.cos(cameraAngle) * 12
            );
            camera.lookAt(player.position);

            butterflies.forEach(b => b.update(dt));
            spiders.forEach(s => s.update(dt));
            undergroundCreatures.forEach(c => c.update(dt));

            renderer.render(scene, camera);
        }

        console.log("Calling setupButtons...");
        setupButtons();
        
        console.log("Setting up menu state...");
        menuState.currentMenu = 'main';
        updateMenuButtons();
        
        console.log("Starting animation loop...");
        animate();
        
        console.log("Game ready! Waiting for Nintendo Switch Controller...");
    </script>
</body>
</html>
